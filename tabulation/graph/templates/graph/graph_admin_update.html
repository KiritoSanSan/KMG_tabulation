{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}
{% block extrahead %}
<link rel="stylesheet" href="{% static 'graph\css\graph_admin.css' %}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
{% endblock %}

{% block branding %}
<div id="site-name"><a href="{% url 'admin:index' %}">Админ Панель</a></div>
{% endblock %}

{% block content %}
{{block.super}}
	<h1>График {{graph.subdivision}} {{graph.reservoir}} {{selected_month}} {{graph.year}}</h1>
  	<table class="admin_table">
		<thead>
		<tr>
			<td rowspan="2">№№/пп</td>
			<td rowspan="2">Фамилия, имя, отчество </td>
			<td rowspan="2">Профессия, должность</td>
			<td rowspan="2">Место-рождение</td>
			<td rowspan="2" class="vertical">Вахта</td>
			<td colspan="{{days|length}}" style="text-align: center">Дни месяца</td>
			<td rowspan="2">Дни вахты</td>
			<td rowspan="2">Дни отдыха</td>
			<td rowspan="2">Всего дней в месяце</td>
			<td rowspan="2">Кол-во часов</td>
		</tr>
		<tr>
			{% for day in days %}
				<td>{{day}}</td>
			{% endfor %}
		</tr>
		</thead>
		<tbody id="id_time_tracking_set-group">
			<form method='POST' action="{% url 'graph:graph_admin_update' %}">
				{% csrf_token %}
				<tr><td style="text-align: center;" colspan="100">за {{selected_month}} {{year}}</td></tr>
				
				{% for employee in employees %}
					<tr>
						<td><a style="cursor: pointer;" id="delete-row-button" class="deletelink" data-custom-value="{{employee.tabel_number}}"></a> {{forloop.counter}}</td>
						<td>{{employee.surname}} {{employee.name}} {{employee.middlename}}</td>
						<td>{{employee.job.name}} {{employee.job.description}}</td>
						<td>{{employee.oil_place}}</td>
						<td>{{employee.tariff_category}}</td>
						{% for day in days %}
							{% for data in time_tracking %}
								{% if data.employee_id.tabel_number == employee.tabel_number %}
									{% if data.date.year == year %}
										{% if data.date.month == month %}
												{% if data.date.day == day %}
													<td><input style = "width: 20px;" type="text" id="timetracking_field" name="worked_hours_{{ data.pk }}_{{day}}_{{employee.tabel_number}}" value="{{ data.worked_hours }}"></td>	
												{% endif %}
										{% endif %}
									{% endif %}
								{% endif %}
							{% endfor %}
						{% endfor %}
			
						{% for key, value in calculations.items %}
							{% if key == employee.name %}
								{% for calculation in value.values %}
									{% if calculation == 0 %}
										<td>0</td>
									{% else %}
										<td>{{calculation}}</td>
									{% endif %}
								{% endfor %}
							{% endif %}
						{% endfor %}
					</tr>
				{% endfor %}
			
			</tbody>
			</table>
			
			<input type="submit" value="Сохранить график" class="default">
			<a href="{% url 'graph:graph_admin' %}">
				<input type="button" value="Назад" class="default">
			</a>
		</form>
		<input id="add-row-button" type="button" value="Добавить работника" class="default">
		<script>
			$(".deletelink").click(function() {
				const value = $(this).data("custom-value");
				const csrftoken = '{{ csrf_token }}'
				console.log(value)
				fetch("{% url 'graph:graph_admin_update' %}", {
					method: "POST",
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': csrftoken,
					},
					body: JSON.stringify({ employee_id_delete: value }),
				})

				.then(response => {
					location.replace("{% url 'graph:graph_admin_update' %}")
				})
				
				
			});

			document.addEventListener("DOMContentLoaded", function() {
				const addRowButton = document.getElementById("add-row-button");
				const tableBody = document.getElementById("id_time_tracking_set-group");
				const csrftoken = '{{ csrf_token }}'
				addRowButton.addEventListener("click", function() {
					const newRow = document.createElement("tr");
					newRow.innerHTML = `
									<td>{{ forloop.counter }}</td>
									<td>
									<input class="employee_select" type="text" name="time_tracking_set-__prefix__-employee_id" list="employee_list">
										<datalist id="employee_list">
											{% for employee in employees_all %}
											<option type="text" name=employee_{{ employee.tabel_number }} value="{{employee.tabel_number}}">{{employee.fullname}}</option>
											{% endfor %}		
										</datalist>
									</td>
									<td><input type="button" value="Добавить" class="save-row-button"></td>
									<td><input type="button" value="Отменить" class="cancel-row-button"></td>
									`;
					tableBody.appendChild(newRow);
				});

				
				tableBody.addEventListener("click", function(event) {
					if (event.target.classList.contains("cancel-row-button")) {
						event.target.closest("tr").remove();
					}
					else if (event.target.classList.contains("save-row-button")) {
						const selectElement = event.target.closest("tr").querySelector(".employee_select");
						const selectedOption = selectElement.value;
						fetch("{% url 'graph:graph_admin_update' %}", {
							method: "POST",
							headers: {
								'Content-Type': 'application/json',
								'X-CSRFToken': csrftoken,
							},
							body: JSON.stringify({ employee_id: selectedOption }),
						})
						.then(response => {
							if (response.ok) {
								console.log('Option saved successfully');
								location.replace("{% url 'graph:graph_admin_update' %}")
							} else {
								console.error('Error saving option');
							}
						})
						.catch(error => {
							console.error('Error:', error);
						});
						console.log(selectedOption)
					}

					

				});//
			});
		</script>
{% endblock %}

